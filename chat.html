<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="AI ì±—ë´‡ - Vocal Class">
    <title>AI ì±—ë´‡ - Vocal Class</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/components.css">
    <style>
        /* ì±„íŒ… ë©”ì‹œì§€ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message {
            animation: slideIn 0.3s ease-out;
        }

        /* íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° */
        .typing-indicator {
            display: inline-flex;
            gap: 4px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #6b7280;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.5;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* ì±„íŒ… ì»¨í…Œì´ë„ˆ ìŠ¤í¬ë¡¤ */
        .chat-messages {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body class="bg-gray-50">
    <nav class="bg-indigo-600 text-white p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <button onclick="history.back()" class="hover:underline text-white">â† ë’¤ë¡œê°€ê¸°</button>
            <h1 class="text-xl font-bold">AI ì±—ë´‡ ìƒë‹´</h1>
            <a href="/" class="hover:underline">í™ˆìœ¼ë¡œ</a>
        </div>
    </nav>

    <main class="container mx-auto p-4 md:p-8 max-w-4xl">
        <!-- ê°•ì‚¬ ì„ íƒ (í•™ìƒ ëª¨ë“œ) -->
        <div id="teacher-selection-section" class="bg-white rounded-lg shadow p-6 mb-4">
            <h2 class="text-lg font-bold mb-4">ê°•ì‚¬ ì„ íƒ</h2>
            <select id="teacher-select" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                <option value="">ê°•ì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”...</option>
                <!-- ë™ì ìœ¼ë¡œ ë¡œë“œë¨ -->
            </select>
            <p class="mt-2 text-sm text-gray-500">AI ì±—ë´‡ê³¼ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ë ¤ë©´ ê°•ì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
        </div>

        <!-- ìˆ˜ê°•ìƒ ì •ë³´ (ê°•ì‚¬ ëª¨ë“œ) -->
        <div id="student-info-section" class="bg-white rounded-lg shadow p-6 mb-4 hidden">
            <h2 class="text-lg font-bold mb-4">ìˆ˜ê°•ìƒ ì •ë³´</h2>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <p class="text-sm text-gray-600">ì´ë¦„</p>
                    <p id="student-name" class="font-bold text-lg">-</p>
                </div>
                <div>
                    <p class="text-sm text-gray-600">ìˆ˜ì—… ê¸°ê°„</p>
                    <p id="student-period" class="font-medium">-</p>
                </div>
                <div>
                    <p class="text-sm text-gray-600">ì¶œì„ íšŸìˆ˜</p>
                    <p id="student-attendance" class="font-medium">-</p>
                </div>
                <div>
                    <p class="text-sm text-gray-600">ì…ê¸ˆ ìƒíƒœ</p>
                    <p id="student-payment" class="font-medium">-</p>
                </div>
            </div>
            <div class="mt-4">
                <p class="text-sm text-gray-600">ë©”ëª¨</p>
                <p id="student-notes" class="text-sm">-</p>
            </div>
        </div>

        <!-- ì±„íŒ… ì°½ -->
        <div class="bg-white rounded-lg shadow flex flex-col" style="height: 600px;">
            <!-- ì±„íŒ… í—¤ë” -->
            <div class="bg-indigo-600 text-white p-4 rounded-t-lg">
                <h3 class="font-bold text-lg" id="chat-header">AI ìƒë‹´ ì±—ë´‡</h3>
                <p class="text-sm text-indigo-100" id="chat-subtitle">ê°•ì‚¬ë‹˜ì„ ì„ íƒí•˜ë©´ ëŒ€í™”ë¥¼ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>

            <!-- ë©”ì‹œì§€ ì˜ì—­ -->
            <div id="chat-messages" class="chat-messages flex-1 overflow-y-auto p-4 space-y-4">
                <!-- í™˜ì˜ ë©”ì‹œì§€ -->
                <div class="flex justify-center">
                    <div class="bg-gray-100 text-gray-600 px-4 py-2 rounded-lg text-sm">
                        ì•ˆë…•í•˜ì„¸ìš”! ê¶ê¸ˆí•˜ì‹  ì ì„ ë¬¼ì–´ë³´ì„¸ìš”.
                    </div>
                </div>
            </div>

            <!-- ì…ë ¥ ì˜ì—­ -->
            <div class="border-t p-4">
                <form id="chat-form" class="flex gap-2">
                    <button
                        type="button"
                        id="voice-button"
                        class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 disabled:bg-gray-300 disabled:cursor-not-allowed"
                        disabled
                        title="ìŒì„± ì…ë ¥"
                    >
                        ğŸ¤
                    </button>
                    <input
                        type="text"
                        id="message-input"
                        placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                        disabled
                    />
                    <button
                        type="submit"
                        id="send-button"
                        class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                        disabled
                    >
                        ì „ì†¡
                    </button>
                </form>
            </div>
        </div>
    </main>

    <script src="js/components.js?v=12"></script>
    <script src="js/auth.js?v=12"></script>
    <script>
        let currentTeacherId = null;
        let currentStudentId = null;
        let sessionKey = null;
        let teachers = [];
        let mode = 'student'; // 'student' or 'teacher'

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const urlMode = urlParams.get('mode'); // 'teacher' or null (student)
            const urlStudentId = urlParams.get('studentId');
            const urlStudentName = urlParams.get('studentName');
            const urlTeacherId = urlParams.get('teacherId');

            if (urlMode === 'teacher' && urlStudentId) {
                // ê°•ì‚¬ ëª¨ë“œ
                mode = 'teacher';
                currentStudentId = parseInt(urlStudentId);

                // ê°•ì‚¬ ì„ íƒ ì„¹ì…˜ ìˆ¨ê¸°ê³  ìˆ˜ê°•ìƒ ì •ë³´ ì„¹ì…˜ í‘œì‹œ
                document.getElementById('teacher-selection-section').classList.add('hidden');
                document.getElementById('student-info-section').classList.remove('hidden');

                // ìˆ˜ê°•ìƒ ì •ë³´ ë¡œë“œ
                await loadStudentInfo(currentStudentId, urlStudentName);

                setupEventListeners();
            } else {
                // í•™ìƒ ëª¨ë“œ (ê¸°ë³¸)
                mode = 'student';
                await loadTeachers();
                setupEventListeners();

                if (urlTeacherId && teachers.find(t => t.id == urlTeacherId)) {
                    selectTeacher(parseInt(urlTeacherId));
                    document.getElementById('teacher-select').value = urlTeacherId;
                }
            }
        });

        // ê°•ì‚¬ ëª©ë¡ ë¡œë“œ
        async function loadTeachers() {
            try {
                const response = await fetch('/api/auth?role=teacher');
                const data = await response.json();

                console.log('Teachers API response:', data); // ë””ë²„ê¹…ìš©

                if (data.users && data.users.length > 0) {
                    teachers = data.users;
                    const select = document.getElementById('teacher-select');

                    data.users.forEach(teacher => {
                        const option = document.createElement('option');
                        option.value = teacher.id;
                        option.textContent = teacher.name;
                        select.appendChild(option);
                    });
                } else {
                    console.warn('No teachers found');
                }
            } catch (error) {
                console.error('Failed to load teachers:', error);
            }
        }

        // ìˆ˜ê°•ìƒ ì •ë³´ ë¡œë“œ (ê°•ì‚¬ ëª¨ë“œ)
        async function loadStudentInfo(studentId, studentName) {
            try {
                const user = (typeof getUser === 'function') ? getUser() : null;
                if (!user || user.role !== 'teacher') {
                    appendMessage('system', 'ê°•ì‚¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    return;
                }

                // ìˆ˜ê°•ìƒ ê¸°ë³¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const response = await fetch(`/api/auth?id=${studentId}`);
                const data = await response.json();

                if (data.user) {
                    const student = data.user;

                    // ìˆ˜ê°•ìƒ ì •ë³´ í‘œì‹œ
                    document.getElementById('student-name').textContent = student.name;
                    document.getElementById('student-period').textContent =
                        `${student.start_date || '-'} ~ ${student.end_date || '-'}`;
                    document.getElementById('student-attendance').textContent =
                        `${student.attendance_count || 0}íšŒ`;
                    document.getElementById('student-payment').textContent =
                        student.payment_status === 'paid' ? 'ì™„ë‚©' : 'ë¯¸ë‚©';
                    document.getElementById('student-notes').textContent =
                        student.notes || 'ë©”ëª¨ ì—†ìŒ';

                    // ì±„íŒ… í—¤ë” ì—…ë°ì´íŠ¸
                    document.getElementById('chat-header').textContent = `${student.name} ìˆ˜ê°•ìƒ AI ì±—ë´‡`;
                    document.getElementById('chat-subtitle').textContent = 'ìˆ˜ê°•ìƒì— ëŒ€í•´ ê¶ê¸ˆí•˜ì‹  ì ì„ ë¬¼ì–´ë³´ì„¸ìš”!';

                    // ì±„íŒ… ì´ˆê¸°í™”
                    const messagesContainer = document.getElementById('chat-messages');
                    messagesContainer.innerHTML = `
                        <div class="flex justify-center">
                            <div class="bg-gray-100 text-gray-600 px-4 py-2 rounded-lg text-sm">
                                ì•ˆë…•í•˜ì„¸ìš”! ${student.name} ìˆ˜ê°•ìƒì— ëŒ€í•œ ì •ë³´ë¥¼ ì•ˆë‚´í•´ë“œë¦½ë‹ˆë‹¤. ê¶ê¸ˆí•˜ì‹  ì ì„ ë¬¼ì–´ë³´ì„¸ìš”.
                            </div>
                        </div>
                    `;

                    // ì…ë ¥ í™œì„±í™”
                    document.getElementById('message-input').disabled = false;
                    document.getElementById('send-button').disabled = false;
                    document.getElementById('voice-button').disabled = false;
                    document.getElementById('message-input').focus();
                } else {
                    appendMessage('system', 'ìˆ˜ê°•ìƒ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('Failed to load student info:', error);
                appendMessage('system', 'ìˆ˜ê°•ìƒ ì •ë³´ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupEventListeners() {
            // ê°•ì‚¬ ì„ íƒ
            document.getElementById('teacher-select').addEventListener('change', (e) => {
                const teacherId = parseInt(e.target.value);
                if (teacherId) {
                    selectTeacher(teacherId);
                } else {
                    currentTeacherId = null;
                    sessionKey = null;
                    disableChat();
                }
            });

            // ë©”ì‹œì§€ ì „ì†¡
            document.getElementById('chat-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                await sendMessage();
            });

            // Enter í‚¤ë¡œ ì „ì†¡
            document.getElementById('message-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    document.getElementById('chat-form').dispatchEvent(new Event('submit'));
                }
            });
        }

        // ê°•ì‚¬ ì„ íƒ
        function selectTeacher(teacherId) {
            currentTeacherId = teacherId;
            const teacher = teachers.find(t => t.id === teacherId);

            if (teacher) {
                document.getElementById('chat-header').textContent = `${teacher.name} ê°•ì‚¬ë‹˜ AI ì±—ë´‡`;
                document.getElementById('chat-subtitle').textContent = 'ê¶ê¸ˆí•˜ì‹  ì ì„ ë¬¼ì–´ë³´ì„¸ìš”!';

                // ì±„íŒ… ì´ˆê¸°í™”
                const messagesContainer = document.getElementById('chat-messages');
                messagesContainer.innerHTML = `
                    <div class="flex justify-center">
                        <div class="bg-gray-100 text-gray-600 px-4 py-2 rounded-lg text-sm">
                            ì•ˆë…•í•˜ì„¸ìš”! ${teacher.name} ê°•ì‚¬ë‹˜ì˜ AI ìƒë‹´ ì±—ë´‡ì…ë‹ˆë‹¤. ê¶ê¸ˆí•˜ì‹  ì ì„ ë¬¼ì–´ë³´ì„¸ìš”.
                        </div>
                    </div>
                `;

                // ì…ë ¥ í™œì„±í™”
                document.getElementById('message-input').disabled = false;
                document.getElementById('send-button').disabled = false;
                document.getElementById('voice-button').disabled = false;
                document.getElementById('message-input').focus();
            }
        }

        // ì±„íŒ… ë¹„í™œì„±í™”
        function disableChat() {
            document.getElementById('chat-header').textContent = 'AI ìƒë‹´ ì±—ë´‡';
            document.getElementById('chat-subtitle').textContent = 'ê°•ì‚¬ë‹˜ì„ ì„ íƒí•˜ë©´ ëŒ€í™”ë¥¼ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
            document.getElementById('message-input').disabled = true;
            document.getElementById('send-button').disabled = true;
        }

        // ë©”ì‹œì§€ ì „ì†¡
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();

            // í•™ìƒ ëª¨ë“œì¼ ë•ŒëŠ” teacherId í•„ìˆ˜, ê°•ì‚¬ ëª¨ë“œì¼ ë•ŒëŠ” studentId í•„ìˆ˜
            if (!message) return;
            if (mode === 'student' && !currentTeacherId) return;
            if (mode === 'teacher' && !currentStudentId) return;

            // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
            appendMessage('user', message);

            // ì…ë ¥ ì´ˆê¸°í™”
            input.value = '';

            // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° í‘œì‹œ
            const typingId = showTypingIndicator();

            try {
                // ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const user = (typeof getUser === 'function') ? getUser() : null;

                const requestBody = {
                    message,
                    sessionKey,
                    mode  // 'student' or 'teacher'
                };

                if (mode === 'student') {
                    // í•™ìƒ ëª¨ë“œ: teacherId í•„ìˆ˜, studentIdëŠ” ë¡œê·¸ì¸í•œ í•™ìƒì¼ ê²½ìš°ì—ë§Œ
                    requestBody.teacherId = currentTeacherId;
                    if (user && user.role === 'student') {
                        requestBody.studentId = user.id;
                    }
                } else {
                    // ê°•ì‚¬ ëª¨ë“œ: studentId í•„ìˆ˜, teacherIdëŠ” ë¡œê·¸ì¸í•œ ê°•ì‚¬
                    requestBody.studentId = currentStudentId;
                    if (user && user.role === 'teacher') {
                        requestBody.teacherId = user.id;
                    }
                }

                const response = await fetch('/api/chatbot', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° ì œê±°
                removeTypingIndicator(typingId);

                if (data.success) {
                    // ì„¸ì…˜ í‚¤ ì €ì¥
                    if (data.sessionKey) {
                        sessionKey = data.sessionKey;
                    }

                    // AI ì‘ë‹µ í‘œì‹œ
                    appendMessage('assistant', data.reply);

                    // ì˜ˆì•½ ìš”ì²­ì´ ìˆìœ¼ë©´ í™•ì¸ ë²„íŠ¼ í‘œì‹œ (í•™ìƒ ëª¨ë“œë§Œ)
                    if (mode === 'student' && data.bookingRequest) {
                        appendBookingConfirmation(data.bookingRequest);
                    }

                    // ì˜ˆì•½ ìŠ¹ì¸ ìš”ì²­ì´ ìˆìœ¼ë©´ í™•ì¸ ë²„íŠ¼ í‘œì‹œ (ê°•ì‚¬ ëª¨ë“œë§Œ)
                    if (mode === 'teacher' && data.approvalRequest) {
                        appendApprovalConfirmation(data.approvalRequest);
                    }
                } else {
                    appendMessage('system', `ì˜¤ë¥˜: ${data.error}`);
                }
            } catch (error) {
                // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° ì œê±°
                removeTypingIndicator(typingId);

                console.error('Send message error:', error);
                appendMessage('system', 'ë©”ì‹œì§€ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ë©”ì‹œì§€ ì¶”ê°€
        function appendMessage(role, content) {
            const messagesContainer = document.getElementById('chat-messages');

            const messageDiv = document.createElement('div');
            messageDiv.className = `message flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;

            const bubble = document.createElement('div');
            bubble.className = `max-w-md px-4 py-2 rounded-lg ${
                role === 'user'
                    ? 'bg-indigo-600 text-white'
                    : role === 'assistant'
                    ? 'bg-gray-200 text-gray-800'
                    : 'bg-yellow-100 text-yellow-800'
            }`;
            bubble.textContent = content;
            bubble.style.whiteSpace = 'pre-wrap';

            messageDiv.appendChild(bubble);
            messagesContainer.appendChild(messageDiv);

            // ìŠ¤í¬ë¡¤ ë§¨ ì•„ë˜ë¡œ
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° í‘œì‹œ
        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chat-messages');

            const typingDiv = document.createElement('div');
            const typingId = `typing-${Date.now()}`;
            typingDiv.id = typingId;
            typingDiv.className = 'message flex justify-start';

            const bubble = document.createElement('div');
            bubble.className = 'bg-gray-200 px-4 py-2 rounded-lg';
            bubble.innerHTML = `
                <div class="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            `;

            typingDiv.appendChild(bubble);
            messagesContainer.appendChild(typingDiv);

            // ìŠ¤í¬ë¡¤ ë§¨ ì•„ë˜ë¡œ
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            return typingId;
        }

        // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° ì œê±°
        function removeTypingIndicator(typingId) {
            const typingDiv = document.getElementById(typingId);
            if (typingDiv) {
                typingDiv.remove();
            }
        }

        // ì˜ˆì•½ í™•ì¸ ë²„íŠ¼ ì¶”ê°€
        function appendBookingConfirmation(bookingRequest) {
            const messagesContainer = document.getElementById('chat-messages');

            const confirmDiv = document.createElement('div');
            confirmDiv.className = 'message flex justify-center my-4';

            const buttonsContainer = document.createElement('div');
            buttonsContainer.className = 'flex gap-2';

            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = 'âœ“ í™•ì¸ (ì˜ˆì•½ ì‹ ì²­)';
            confirmBtn.className = 'px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700';
            confirmBtn.onclick = async () => {
                await confirmBooking(bookingRequest);
                confirmDiv.remove();
            };

            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'âœ— ì·¨ì†Œ';
            cancelBtn.className = 'px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700';
            cancelBtn.onclick = () => {
                confirmDiv.remove();
                appendMessage('system', 'ì˜ˆì•½ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            };

            buttonsContainer.appendChild(confirmBtn);
            buttonsContainer.appendChild(cancelBtn);
            confirmDiv.appendChild(buttonsContainer);
            messagesContainer.appendChild(confirmDiv);

            // ìŠ¤í¬ë¡¤ ë§¨ ì•„ë˜ë¡œ
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // ì˜ˆì•½ í™•ì • (í•™ìƒ ëª¨ë“œ)
        async function confirmBooking(bookingRequest) {
            try {
                const user = (typeof getUser === 'function') ? getUser() : null;
                if (!user) {
                    appendMessage('system', 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    return;
                }

                const response = await fetch('/api/bookings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        studentId: user.id,
                        teacherId: currentTeacherId,
                        bookingDate: bookingRequest.booking_date,
                        suggestedTimeSlots: bookingRequest.time_slots
                    })
                });

                const data = await response.json();

                if (data.ok || data.success) {
                    appendMessage('system', 'âœ… ì˜ˆì•½ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ê°•ì‚¬ ìŠ¹ì¸ í›„ í™•ì •ë©ë‹ˆë‹¤.');
                } else {
                    appendMessage('system', `âŒ ì˜ˆì•½ ì‹¤íŒ¨: ${data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                }
            } catch (error) {
                console.error('Booking error:', error);
                appendMessage('system', 'ì˜ˆì•½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì˜ˆì•½ ìŠ¹ì¸ í™•ì¸ ë²„íŠ¼ ì¶”ê°€ (ê°•ì‚¬ ëª¨ë“œ)
        function appendApprovalConfirmation(approvalRequest) {
            const messagesContainer = document.getElementById('chat-messages');

            const confirmDiv = document.createElement('div');
            confirmDiv.className = 'message flex justify-center my-4';

            const buttonsContainer = document.createElement('div');
            buttonsContainer.className = 'flex gap-2';

            const approveBtn = document.createElement('button');
            approveBtn.textContent = 'âœ“ ìŠ¹ì¸';
            approveBtn.className = 'px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700';
            approveBtn.onclick = async () => {
                await approveBooking(approvalRequest.booking_id, 'approved');
                confirmDiv.remove();
            };

            const rejectBtn = document.createElement('button');
            rejectBtn.textContent = 'âœ— ê±°ì ˆ';
            rejectBtn.className = 'px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700';
            rejectBtn.onclick = async () => {
                await approveBooking(approvalRequest.booking_id, 'rejected');
                confirmDiv.remove();
            };

            buttonsContainer.appendChild(approveBtn);
            buttonsContainer.appendChild(rejectBtn);
            confirmDiv.appendChild(buttonsContainer);
            messagesContainer.appendChild(confirmDiv);

            // ìŠ¤í¬ë¡¤ ë§¨ ì•„ë˜ë¡œ
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // ì˜ˆì•½ ìŠ¹ì¸/ê±°ì ˆ (ê°•ì‚¬ ëª¨ë“œ)
        async function approveBooking(bookingId, status) {
            try {
                // bookings APIëŠ” action íŒŒë¼ë¯¸í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤
                const action = status === 'approved' ? 'approve' : 'reject';

                const response = await fetch(`/api/bookings?id=${bookingId}&action=${action}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.ok || data.success) {
                    if (status === 'approved') {
                        appendMessage('system', 'âœ… ì˜ˆì•½ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } else {
                        appendMessage('system', 'âŒ ì˜ˆì•½ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤.');
                    }
                } else {
                    appendMessage('system', `ì˜¤ë¥˜: ${data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                }
            } catch (error) {
                console.error('Approval error:', error);
                appendMessage('system', 'ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // Web Speech API (ìŒì„± ì¸ì‹)
        let recognition = null;
        let isListening = false;

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'ko-KR';
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('message-input').value = transcript;
                isListening = false;
                document.getElementById('voice-button').textContent = 'ğŸ¤';
                document.getElementById('voice-button').classList.remove('bg-red-500', 'text-white');
                document.getElementById('voice-button').classList.add('bg-gray-100', 'text-gray-700');
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                isListening = false;
                document.getElementById('voice-button').textContent = 'ğŸ¤';
                document.getElementById('voice-button').classList.remove('bg-red-500', 'text-white');
                document.getElementById('voice-button').classList.add('bg-gray-100', 'text-gray-700');
            };

            recognition.onend = () => {
                isListening = false;
                document.getElementById('voice-button').textContent = 'ğŸ¤';
                document.getElementById('voice-button').classList.remove('bg-red-500', 'text-white');
                document.getElementById('voice-button').classList.add('bg-gray-100', 'text-gray-700');
            };
        }

        // ìŒì„± ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('voice-button').addEventListener('click', () => {
            if (!recognition) {
                alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Chromeì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (isListening) {
                recognition.stop();
                isListening = false;
            } else {
                recognition.start();
                isListening = true;
                document.getElementById('voice-button').textContent = 'â¹';
                document.getElementById('voice-button').classList.remove('bg-gray-100', 'text-gray-700');
                document.getElementById('voice-button').classList.add('bg-red-500', 'text-white');
            }
        });
    </script>
</body>
</html>
