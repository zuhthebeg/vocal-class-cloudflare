<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ë³´ì»¬ í´ë˜ìŠ¤ ìˆ˜ê°•ìƒ í˜ì´ì§€ - ìˆ˜ì—… ì˜ˆì•½ ë° ì¶œì„ ê´€ë¦¬">
    <title>ìˆ˜ê°•ìƒ í˜ì´ì§€ - Vocal Class</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/components.css">
</head>
<body class="bg-gray-50">

    <nav class="bg-indigo-600 text-white p-4 shadow-md" role="navigation" aria-label="ì£¼ìš” ë„¤ë¹„ê²Œì´ì…˜">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">ìˆ˜ê°•ìƒ í˜ì´ì§€</h1>
            <div role="group" aria-label="ì‚¬ìš©ì ë©”ë‰´">
                <span id="user-name" class="mr-4" aria-live="polite"></span>
                <a href="/tools" class="hover:underline mr-4" aria-label="ìˆ˜ì—…ë„êµ¬ í˜ì´ì§€ë¡œ ì´ë™">ìˆ˜ì—…ë„êµ¬</a>
                <button id="logout-btn" class="btn btn-danger btn-sm" aria-label="ë¡œê·¸ì•„ì›ƒ">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4 md:p-8" role="main">
        <!-- ìˆ˜ê°•ìƒ ëŒ€ì‹œë³´ë“œ -->
        <section class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-6 rounded-lg shadow-lg mb-8" aria-labelledby="dashboard-heading">
            <h2 id="dashboard-heading" class="text-2xl font-bold mb-4">ë‚˜ì˜ ìˆ˜ê°• í˜„í™©</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <!-- ë§ˆì§€ë§‰ ìˆ˜ê°• ê°•ì‚¬ -->
                <div class="bg-white bg-opacity-20 backdrop-blur-sm p-4 rounded-lg">
                    <p class="text-sm opacity-90 mb-1">ë§ˆì§€ë§‰ ìˆ˜ê°• ê°•ì‚¬</p>
                    <p id="last-teacher" class="text-xl font-bold">-</p>
                    <button id="view-last-teacher-profile" class="mt-2 text-sm underline hover:text-indigo-200 hidden">
                        í”„ë¡œí•„ ë³´ê¸°
                    </button>
                </div>

                <!-- ë‹¤ìŒ ì˜ˆì • ìˆ˜ì—… -->
                <div class="bg-white bg-opacity-20 backdrop-blur-sm p-4 rounded-lg">
                    <p class="text-sm opacity-90 mb-1">ë‹¤ìŒ ì˜ˆì • ìˆ˜ì—…</p>
                    <p id="next-class-date" class="text-lg font-bold">-</p>
                    <p id="next-class-time" class="text-sm opacity-90">-</p>
                </div>

                <!-- ìµœê·¼ ì¶œì„ -->
                <div class="bg-white bg-opacity-20 backdrop-blur-sm p-4 rounded-lg">
                    <p class="text-sm opacity-90 mb-1">ìµœê·¼ ì¶œì„</p>
                    <p id="last-attendance-date" class="text-lg font-bold">-</p>
                    <p id="last-attendance-status" class="text-sm">-</p>
                </div>

                <!-- ì´ ìˆ˜ê°• íšŸìˆ˜ -->
                <div class="bg-white bg-opacity-20 backdrop-blur-sm p-4 rounded-lg">
                    <p class="text-sm opacity-90 mb-1">ì´ ìˆ˜ê°• íšŸìˆ˜</p>
                    <p id="total-classes" class="text-3xl font-bold">0</p>
                    <p class="text-sm opacity-90">íšŒ</p>
                </div>
            </div>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- ìˆ˜ì—… ì˜ˆì•½ -->
        <section class="lg:col-span-2 bg-white p-6 rounded-lg shadow" aria-labelledby="booking-heading">
            <h2 id="booking-heading" class="text-2xl font-bold mb-4">ìˆ˜ì—… ì˜ˆì•½í•˜ê¸°</h2>
            <p class="mb-4 text-gray-600">ê°•ì‚¬ë¥¼ ì„ íƒí•˜ê³  ë‚ ì§œë¥¼ ì„ íƒí•˜ì—¬ ê°€ëŠ¥í•œ ì‹œê°„ì„ í™•ì¸í•˜ê³  ì˜ˆì•½í•˜ì„¸ìš”.</p>

            <!-- ê°•ì‚¬ ì„ íƒ -->
            <div class="mb-6">
                <label for="teacher-select" class="block text-sm font-medium text-gray-700 mb-2">ê°•ì‚¬ ì„ íƒ</label>
                <div class="flex gap-2">
                    <select id="teacher-select" class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" aria-label="ê°•ì‚¬ ì„ íƒ">
                        <option value="">ê°•ì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        <!-- ê°•ì‚¬ ëª©ë¡ì€ JSë¡œ ë™ì  ìƒì„± -->
                    </select>
                    <button id="view-teacher-profile-btn" class="btn btn-secondary whitespace-nowrap" disabled>
                        ê°•ì‚¬ í”„ë¡œí•„
                    </button>
                </div>
            </div>

            <!-- ë‹¬ë ¥ ë„¤ë¹„ê²Œì´ì…˜ -->
            <div class="flex justify-between items-center mb-4">
                <button id="prev-month-btn" class="btn btn-secondary btn-sm" aria-label="ì´ì „ ë‹¬">
                    &lt; ì´ì „
                </button>
                <h3 id="current-month" class="text-lg font-bold"></h3>
                <button id="next-month-btn" class="btn btn-secondary btn-sm" aria-label="ë‹¤ìŒ ë‹¬">
                    ë‹¤ìŒ &gt;
                </button>
            </div>

            <!-- ë‹¬ë ¥ -->
            <div id="calendar-container" class="mb-6" role="region" aria-label="ìˆ˜ì—… ê°€ëŠ¥ ë‚ ì§œ ë‹¬ë ¥">
                <!-- ë‹¬ë ¥ì€ JSë¡œ ë™ì  ìƒì„± -->
            </div>

            <!-- ì„ íƒëœ ë‚ ì§œì˜ ì‹œê°„ ìŠ¬ë¡¯ (ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„) -->
            <div id="timeslot-panel" class="hidden">
                <h3 class="font-bold mb-3" id="selected-date-title"></h3>
                <div id="timeslot-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 mb-4">
                    <!-- ì‹œê°„ ìŠ¬ë¡¯ì€ JSë¡œ ë™ì  ìƒì„± -->
                </div>
                <button id="close-timeslot-btn" class="btn btn-secondary w-full">ë‹«ê¸°</button>
            </div>
        </section>

        <!-- ë‚˜ì˜ ì˜ˆì•½ í˜„í™© -->
        <section class="bg-white p-6 rounded-lg shadow" aria-labelledby="my-bookings-heading">
            <h2 id="my-bookings-heading" class="text-2xl font-bold mb-4">ë‚˜ì˜ ì˜ˆì•½ í˜„í™©</h2>
            <div id="my-booking-list"
                 class="space-y-3 mb-6 h-64 overflow-y-auto"
                 role="region"
                 aria-label="ë‚˜ì˜ ìˆ˜ì—… ì˜ˆì•½ ëª©ë¡"
                 aria-live="polite">
                <!-- ë‚˜ì˜ ì˜ˆì•½ ëª©ë¡ì€ JSë¡œ ë™ì  ìƒì„± -->
            </div>
            <a href="/signature"
               class="btn btn-success w-full block text-center"
               aria-label="ì¶œì„í•˜ê¸° - QR ìŠ¤ìº” ë˜ëŠ” ì§ì ‘ ì„œëª…">
               ì¶œì„í•˜ê¸° (QR ìŠ¤ìº” ë˜ëŠ” ì§ì ‘ ì„œëª…)
            </a>
        </section>
        </div>

        <!-- PT ìš´ë™ ì¼ì§€ ì„¹ì…˜ (PT ìˆ˜ì—…ì¼ ë•Œë§Œ í‘œì‹œ) -->
        <section id="workout-log-section" class="hidden bg-white p-6 rounded-lg shadow mt-8" aria-labelledby="workout-log-heading">
            <div class="flex justify-between items-center mb-4">
                <h2 id="workout-log-heading" class="text-2xl font-bold">ğŸ’ª PT ìš´ë™ ì¼ì§€</h2>
                <button id="open-workout-log-modal" class="btn btn-primary">
                    + ê¸°ë¡ ì¶”ê°€
                </button>
            </div>
            <p class="text-gray-600 mb-4">ìš´ë™ ê¸°ë¡ì„ ìì—°ì–´ë¡œ ì‘ì„±í•˜ì„¸ìš”. ì˜ˆ: "ë ˆê·¸í”„ë ˆìŠ¤ 10íšŒ, ì£¼ì˜ì‚¬í•­ - ë‹¤ë¦¬ì¡°ì‹¬"</p>

            <div id="workout-log-list" class="space-y-3 max-h-96 overflow-y-auto" aria-live="polite">
                <!-- ìš´ë™ ê¸°ë¡ì€ JSë¡œ ë™ì  ìƒì„± -->
                <p class="text-gray-400 text-center py-8">ìš´ë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        </section>
    </main>

    <!-- ë¦¬ë·° ì‘ì„± ëª¨ë‹¬ -->
    <div id="review-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 md:p-8 max-w-md w-full mx-4">
            <h3 class="text-2xl font-bold mb-4">ìˆ˜ì—… ë¦¬ë·° ì‘ì„±</h3>

            <form id="review-form" class="space-y-4">
                <input type="hidden" id="review-booking-id">
                <input type="hidden" id="review-teacher-id">

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        í‰ì  <span class="text-red-500">*</span>
                    </label>
                    <div class="flex gap-2" id="rating-input">
                        <button type="button" class="rating-star text-3xl text-gray-300 hover:text-yellow-400 transition" data-rating="1">â˜…</button>
                        <button type="button" class="rating-star text-3xl text-gray-300 hover:text-yellow-400 transition" data-rating="2">â˜…</button>
                        <button type="button" class="rating-star text-3xl text-gray-300 hover:text-yellow-400 transition" data-rating="3">â˜…</button>
                        <button type="button" class="rating-star text-3xl text-gray-300 hover:text-yellow-400 transition" data-rating="4">â˜…</button>
                        <button type="button" class="rating-star text-3xl text-gray-300 hover:text-yellow-400 transition" data-rating="5">â˜…</button>
                    </div>
                    <input type="hidden" id="selected-rating" value="0">
                </div>

                <div>
                    <label for="review-comment" class="block text-sm font-medium text-gray-700 mb-2">
                        í›„ê¸° (ì„ íƒì‚¬í•­)
                    </label>
                    <textarea id="review-comment" rows="4"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                              placeholder="ìˆ˜ì—…ì— ëŒ€í•œ ì†Œê°ì„ ë‚¨ê²¨ì£¼ì„¸ìš”..."></textarea>
                </div>

                <div class="flex gap-3">
                    <button type="submit" class="btn btn-primary flex-1">
                        ë¦¬ë·° ì œì¶œ
                    </button>
                    <button type="button" id="close-review-modal" class="btn btn-secondary flex-1">
                        ì·¨ì†Œ
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ìš´ë™ ì¼ì§€ ì‘ì„± ëª¨ë‹¬ -->
    <div id="workout-log-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 md:p-8 max-w-lg w-full mx-4">
            <h3 class="text-2xl font-bold mb-4">ğŸ’ª ìš´ë™ ê¸°ë¡ ì‘ì„±</h3>

            <form id="workout-log-form" class="space-y-4">
                <div>
                    <label for="workout-date" class="block text-sm font-medium text-gray-700 mb-2">
                        ë‚ ì§œ
                    </label>
                    <input type="date" id="workout-date"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    <p class="text-xs text-gray-500 mt-1">ë¹„ì›Œë‘ë©´ ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì €ì¥ë©ë‹ˆë‹¤.</p>
                </div>

                <div>
                    <label for="workout-content" class="block text-sm font-medium text-gray-700 mb-2">
                        ìš´ë™ ë‚´ìš© <span class="text-red-500">*</span>
                    </label>
                    <textarea id="workout-content" rows="6"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                              placeholder="ì˜ˆì‹œ:
ë ˆê·¸í”„ë ˆìŠ¤ 10íšŒ, ì£¼ì˜ì‚¬í•­ - ë‹¤ë¦¬ì¡°ì‹¬
ë²¤ì¹˜í”„ë ˆìŠ¤ 10íšŒ 3ì„¸íŠ¸, ì£¼ì˜ì‚¬í•­ - íŒ”ì¡°ì‹¬
ëŸ°ë‹ë¨¸ì‹  30ë¶„

ììœ ë¡­ê²Œ ì‘ì„±í•˜ì„¸ìš”!"></textarea>
                </div>

                <div class="flex gap-3">
                    <button type="submit" class="btn btn-primary flex-1">
                        ì €ì¥í•˜ê¸°
                    </button>
                    <button type="button" id="close-workout-log-modal" class="btn btn-secondary flex-1">
                        ì·¨ì†Œ
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ìš´ë™ ì¼ì§€ ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="workout-edit-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 md:p-8 max-w-lg w-full mx-4">
            <h3 class="text-2xl font-bold mb-4">âœï¸ ìš´ë™ ê¸°ë¡ ìˆ˜ì •</h3>

            <form id="workout-edit-form" class="space-y-4">
                <input type="hidden" id="edit-workout-id">

                <div>
                    <label for="edit-workout-date" class="block text-sm font-medium text-gray-700 mb-2">
                        ë‚ ì§œ
                    </label>
                    <input type="date" id="edit-workout-date"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <div>
                    <label for="edit-workout-content" class="block text-sm font-medium text-gray-700 mb-2">
                        ìš´ë™ ë‚´ìš© <span class="text-red-500">*</span>
                    </label>
                    <textarea id="edit-workout-content" rows="6"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>

                <div class="flex gap-3">
                    <button type="submit" class="btn btn-primary flex-1">
                        ìˆ˜ì •í•˜ê¸°
                    </button>
                    <button type="button" id="close-workout-edit-modal" class="btn btn-secondary flex-1">
                        ì·¨ì†Œ
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/components.js?v=8"></script>
    <script src="js/auth.js?v=8"></script>
    <script src="js/student.js?v=8"></script>
    <script>
        // ë¦¬ë·° ëª¨ë‹¬ ê´€ë ¨ ìŠ¤í¬ë¦½íŠ¸
        let selectedRating = 0;

        // ë³„ì  ì„ íƒ ì´ë²¤íŠ¸
        document.querySelectorAll('.rating-star').forEach(star => {
            star.addEventListener('click', (e) => {
                e.preventDefault();
                const rating = parseInt(e.target.dataset.rating);
                selectedRating = rating;
                document.getElementById('selected-rating').value = rating;

                // ë³„ì  UI ì—…ë°ì´íŠ¸
                document.querySelectorAll('.rating-star').forEach((s, index) => {
                    if (index < rating) {
                        s.classList.remove('text-gray-300');
                        s.classList.add('text-yellow-400');
                    } else {
                        s.classList.remove('text-yellow-400');
                        s.classList.add('text-gray-300');
                    }
                });
            });
        });

        // ë¦¬ë·° ëª¨ë‹¬ ì—´ê¸° (ê¸€ë¡œë²Œ í•¨ìˆ˜)
        window.openReviewModal = function(bookingId, teacherId) {
            document.getElementById('review-booking-id').value = bookingId;
            document.getElementById('review-teacher-id').value = teacherId;
            document.getElementById('review-modal').classList.remove('hidden');
            document.getElementById('review-modal').classList.add('flex');

            // í¼ ì´ˆê¸°í™”
            selectedRating = 0;
            document.getElementById('selected-rating').value = 0;
            document.getElementById('review-comment').value = '';
            document.querySelectorAll('.rating-star').forEach(s => {
                s.classList.remove('text-yellow-400');
                s.classList.add('text-gray-300');
            });
        };

        // ë¦¬ë·° ëª¨ë‹¬ ë‹«ê¸°
        document.getElementById('close-review-modal').addEventListener('click', () => {
            document.getElementById('review-modal').classList.add('hidden');
            document.getElementById('review-modal').classList.remove('flex');
        });

        // ë¦¬ë·° ì œì¶œ
        document.getElementById('review-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const bookingId = document.getElementById('review-booking-id').value;
            const teacherId = document.getElementById('review-teacher-id').value;
            const rating = parseInt(document.getElementById('selected-rating').value);
            const comment = document.getElementById('review-comment').value.trim();

            if (rating === 0) {
                if (typeof showToast === 'function') {
                    showToast('ë³„ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                } else {
                    alert('ë³„ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                }
                return;
            }

            try {
                if (typeof showLoading === 'function') {
                    showLoading(true);
                }

                const user = getUser();
                const response = await fetch('/api/reviews', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        bookingId: parseInt(bookingId),
                        studentId: user.id,
                        teacherId: parseInt(teacherId),
                        rating: rating,
                        comment: comment || null
                    })
                });

                const data = await response.json();

                if (typeof showLoading === 'function') {
                    showLoading(false);
                }

                if (data.success) {
                    if (typeof showToast === 'function') {
                        showToast('ë¦¬ë·°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    } else {
                        alert('ë¦¬ë·°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    }

                    // ëª¨ë‹¬ ë‹«ê¸°
                    document.getElementById('review-modal').classList.add('hidden');
                    document.getElementById('review-modal').classList.remove('flex');

                    // ì˜ˆì•½ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (student.jsì˜ í•¨ìˆ˜ í˜¸ì¶œ)
                    if (typeof loadMyBookings === 'function') {
                        loadMyBookings();
                    }
                } else {
                    throw new Error(data.error || 'ë¦¬ë·° ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('Failed to submit review:', error);
                if (typeof showLoading === 'function') {
                    showLoading(false);
                }
                if (typeof showToast === 'function') {
                    showToast(error.message, 'error');
                } else {
                    alert(error.message);
                }
            }
        });

        // ê°•ì‚¬ í”„ë¡œí•„ ë³´ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
        const teacherSelect = document.getElementById('teacher-select');
        const viewProfileBtn = document.getElementById('view-teacher-profile-btn');

        teacherSelect.addEventListener('change', () => {
            if (teacherSelect.value) {
                viewProfileBtn.disabled = false;
            } else {
                viewProfileBtn.disabled = true;
            }
        });

        viewProfileBtn.addEventListener('click', () => {
            const teacherId = teacherSelect.value;
            if (teacherId) {
                window.location.href = `/teacher-profile-view?teacherId=${teacherId}`;
            }
        });

        // ========== PT ìš´ë™ ì¼ì§€ ê¸°ëŠ¥ ==========

        // PT ì¹´í…Œê³ ë¦¬ í™•ì¸ ë° ì„¹ì…˜ í‘œì‹œ
        async function checkAndShowWorkoutSection() {
            try {
                const user = getUser();
                if (!user || !user.id) return;

                // í•™ìƒì˜ ì˜ˆì•½ ëª©ë¡ì—ì„œ PT ìˆ˜ì—…ì´ ìˆëŠ”ì§€ í™•ì¸
                const response = await fetch(`/api/bookings?studentId=${user.id}`);
                const data = await response.json();

                if (!response.ok) return;

                const bookings = data.bookings || [];

                // PT ê°•ì‚¬ì™€ ì˜ˆì•½ ì´ë ¥ì´ ìˆëŠ”ì§€ í™•ì¸ (ì¹´í…Œê³ ë¦¬ ID 2 = PT)
                // ë˜ëŠ” ë‹¨ìˆœíˆ ìš´ë™ ì¼ì§€ ì„¹ì…˜ì„ í•­ìƒ í‘œì‹œ (PT í•™ìƒìš©)
                // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ í•­ìƒ í‘œì‹œí•˜ë„ë¡ í•¨ (ë‚˜ì¤‘ì— ì¹´í…Œê³ ë¦¬ í•„í„° ì¶”ê°€ ê°€ëŠ¥)
                const workoutSection = document.getElementById('workout-log-section');
                if (workoutSection) {
                    workoutSection.classList.remove('hidden');
                    loadWorkoutLogs();
                }
            } catch (error) {
                console.error('Failed to check workout section:', error);
            }
        }

        // ìš´ë™ ì¼ì§€ ëª©ë¡ ë¡œë“œ
        async function loadWorkoutLogs() {
            try {
                const user = getUser();
                if (!user || !user.id) return;

                const response = await fetch(`/api/workout-logs?studentId=${user.id}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load workout logs');
                }

                renderWorkoutLogs(data.logs || []);
            } catch (error) {
                console.error('Load workout logs error:', error);
            }
        }

        // ìš´ë™ ì¼ì§€ ë Œë”ë§
        function renderWorkoutLogs(logs) {
            const container = document.getElementById('workout-log-list');
            if (!container) return;

            if (logs.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-8">ìš´ë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            container.innerHTML = logs.map(log => {
                const logDate = new Date(log.log_date);
                const formattedDate = logDate.toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'short'
                });

                // ë‚´ìš©ì„ ì¤„ë°”ê¿ˆìœ¼ë¡œ ë¶„ë¦¬í•˜ì—¬ ë¦¬ìŠ¤íŠ¸ë¡œ í‘œì‹œ
                const contentLines = log.content.split('\n').filter(line => line.trim());

                return `
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-sm font-medium text-indigo-600">${formattedDate}</span>
                            <div class="flex gap-2">
                                <button onclick="openWorkoutEditModal(${log.id}, '${log.log_date}', \`${log.content.replace(/`/g, '\\`').replace(/\\/g, '\\\\')}\`)"
                                        class="text-xs text-gray-500 hover:text-indigo-600">
                                    ìˆ˜ì •
                                </button>
                                <button onclick="deleteWorkoutLog(${log.id})"
                                        class="text-xs text-gray-500 hover:text-red-600">
                                    ì‚­ì œ
                                </button>
                            </div>
                        </div>
                        <div class="text-gray-700 whitespace-pre-line">${escapeHtml(log.content)}</div>
                    </div>
                `;
            }).join('');
        }

        // HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ìš´ë™ ì¼ì§€ ëª¨ë‹¬ ì—´ê¸°
        document.getElementById('open-workout-log-modal').addEventListener('click', () => {
            document.getElementById('workout-log-modal').classList.remove('hidden');
            document.getElementById('workout-log-modal').classList.add('flex');

            // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('workout-date').value = today;
            document.getElementById('workout-content').value = '';
        });

        // ìš´ë™ ì¼ì§€ ëª¨ë‹¬ ë‹«ê¸°
        document.getElementById('close-workout-log-modal').addEventListener('click', () => {
            document.getElementById('workout-log-modal').classList.add('hidden');
            document.getElementById('workout-log-modal').classList.remove('flex');
        });

        // ìš´ë™ ì¼ì§€ ì €ì¥
        document.getElementById('workout-log-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const content = document.getElementById('workout-content').value.trim();
            const logDate = document.getElementById('workout-date').value;

            if (!content) {
                if (typeof showToast === 'function') {
                    showToast('ìš´ë™ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                } else {
                    alert('ìš´ë™ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                }
                return;
            }

            try {
                if (typeof showLoading === 'function') {
                    showLoading(true);
                }

                const user = getUser();
                const response = await fetch('/api/workout-logs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        studentId: user.id,
                        logDate: logDate || null,
                        content: content
                    })
                });

                const data = await response.json();

                if (typeof showLoading === 'function') {
                    showLoading(false);
                }

                if (data.ok) {
                    if (typeof showToast === 'function') {
                        showToast('ìš´ë™ ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    } else {
                        alert('ìš´ë™ ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    }

                    // ëª¨ë‹¬ ë‹«ê¸°
                    document.getElementById('workout-log-modal').classList.add('hidden');
                    document.getElementById('workout-log-modal').classList.remove('flex');

                    // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    loadWorkoutLogs();
                } else {
                    throw new Error(data.error || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('Failed to save workout log:', error);
                if (typeof showLoading === 'function') {
                    showLoading(false);
                }
                if (typeof showToast === 'function') {
                    showToast(error.message, 'error');
                } else {
                    alert(error.message);
                }
            }
        });

        // ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
        window.openWorkoutEditModal = function(logId, logDate, content) {
            document.getElementById('edit-workout-id').value = logId;
            document.getElementById('edit-workout-date').value = logDate;
            document.getElementById('edit-workout-content').value = content;

            document.getElementById('workout-edit-modal').classList.remove('hidden');
            document.getElementById('workout-edit-modal').classList.add('flex');
        };

        // ìˆ˜ì • ëª¨ë‹¬ ë‹«ê¸°
        document.getElementById('close-workout-edit-modal').addEventListener('click', () => {
            document.getElementById('workout-edit-modal').classList.add('hidden');
            document.getElementById('workout-edit-modal').classList.remove('flex');
        });

        // ìš´ë™ ì¼ì§€ ìˆ˜ì •
        document.getElementById('workout-edit-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const logId = document.getElementById('edit-workout-id').value;
            const content = document.getElementById('edit-workout-content').value.trim();
            const logDate = document.getElementById('edit-workout-date').value;

            if (!content) {
                if (typeof showToast === 'function') {
                    showToast('ìš´ë™ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                } else {
                    alert('ìš´ë™ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                }
                return;
            }

            try {
                if (typeof showLoading === 'function') {
                    showLoading(true);
                }

                const response = await fetch(`/api/workout-logs?id=${logId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: content,
                        logDate: logDate
                    })
                });

                const data = await response.json();

                if (typeof showLoading === 'function') {
                    showLoading(false);
                }

                if (data.ok) {
                    if (typeof showToast === 'function') {
                        showToast('ìš´ë™ ê¸°ë¡ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    } else {
                        alert('ìš´ë™ ê¸°ë¡ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    }

                    // ëª¨ë‹¬ ë‹«ê¸°
                    document.getElementById('workout-edit-modal').classList.add('hidden');
                    document.getElementById('workout-edit-modal').classList.remove('flex');

                    // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    loadWorkoutLogs();
                } else {
                    throw new Error(data.error || 'ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('Failed to update workout log:', error);
                if (typeof showLoading === 'function') {
                    showLoading(false);
                }
                if (typeof showToast === 'function') {
                    showToast(error.message, 'error');
                } else {
                    alert(error.message);
                }
            }
        });

        // ìš´ë™ ì¼ì§€ ì‚­ì œ
        window.deleteWorkoutLog = async function(logId) {
            if (!confirm('ì´ ìš´ë™ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                if (typeof showLoading === 'function') {
                    showLoading(true);
                }

                const response = await fetch(`/api/workout-logs?id=${logId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (typeof showLoading === 'function') {
                    showLoading(false);
                }

                if (data.ok) {
                    if (typeof showToast === 'function') {
                        showToast('ìš´ë™ ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    } else {
                        alert('ìš´ë™ ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    }
                    loadWorkoutLogs();
                } else {
                    throw new Error(data.error || 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('Failed to delete workout log:', error);
                if (typeof showLoading === 'function') {
                    showLoading(false);
                }
                if (typeof showToast === 'function') {
                    showToast(error.message, 'error');
                } else {
                    alert(error.message);
                }
            }
        };

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìš´ë™ ì¼ì§€ ì„¹ì…˜ í™•ì¸
        document.addEventListener('DOMContentLoaded', () => {
            // ì ì‹œ í›„ ì‹¤í–‰ (auth.js ë¡œë“œ í›„)
            setTimeout(() => {
                checkAndShowWorkoutSection();
            }, 500);
        });
    </script>
</body>
</html>
