<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="PT ìš´ë™ ì¼ì§€ - ìš´ë™ ê¸°ë¡ ë° í†µê³„">
    <title>ìš´ë™ ì¼ì§€ - Vocal Class</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/components.css">
</head>
<body class="bg-gray-50">

    <nav class="bg-indigo-600 text-white p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <a href="/student" class="hover:bg-indigo-700 px-3 py-1 rounded">â† ë’¤ë¡œ</a>
                <h1 class="text-xl font-bold">ğŸ’ª PT ìš´ë™ ì¼ì§€</h1>
            </div>
            <div>
                <span id="user-name" class="mr-4"></span>
                <button id="logout-btn" class="btn btn-danger btn-sm">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4 md:p-8">
        <!-- í—¤ë” + ê¸°ë¡ ì¶”ê°€ ë²„íŠ¼ -->
        <div class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-2xl font-bold text-gray-800">ë‚˜ì˜ ìš´ë™ ê¸°ë¡</h2>
                <p class="text-gray-600">ìì—°ì–´ë¡œ ìš´ë™ì„ ê¸°ë¡í•˜ë©´ AIê°€ ìë™ìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤</p>
            </div>
            <button id="open-add-modal" class="btn btn-primary">
                + ê¸°ë¡ ì¶”ê°€
            </button>
        </div>

        <!-- ì´ë²ˆ ì£¼ ìš”ì•½ ì¹´ë“œ -->
        <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-lg shadow">
                <p class="text-sm opacity-90 mb-1">ì´ë²ˆ ì£¼ ìš´ë™</p>
                <p id="stat-workouts" class="text-3xl font-bold">0íšŒ</p>
            </div>
            <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-6 rounded-lg shadow">
                <p class="text-sm opacity-90 mb-1">ê°€ì¥ ë§ì´ í•œ ë¶€ìœ„</p>
                <p id="stat-bodypart" class="text-3xl font-bold">-</p>
            </div>
            <div class="bg-gradient-to-r from-orange-500 to-orange-600 text-white p-6 rounded-lg shadow">
                <p class="text-sm opacity-90 mb-1">ì—°ì† ìš´ë™</p>
                <p id="stat-streak" class="text-3xl font-bold">0ì¼</p>
            </div>
        </section>

        <!-- ì°¨íŠ¸ ì˜ì—­ -->
        <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- ë¶€ìœ„ë³„ ë¶„í¬ ì°¨íŠ¸ -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-bold mb-4">ğŸ“Š ë¶€ìœ„ë³„ ìš´ë™ ë¶„í¬</h3>
                <div class="relative h-64">
                    <canvas id="bodyPartChart"></canvas>
                </div>
                <p id="no-bodypart-data" class="hidden text-gray-400 text-center py-8">ìš´ë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>
            </div>

            <!-- ìš´ë™ ì§„í–‰ ì¶”ì´ ì°¨íŠ¸ -->
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">ğŸ“ˆ ìš´ë™ ì§„í–‰ ì¶”ì´</h3>
                    <select id="progress-exercise-select" class="text-sm border rounded px-2 py-1">
                        <option value="">ìš´ë™ ì„ íƒ</option>
                    </select>
                </div>
                <div class="relative h-64">
                    <canvas id="progressChart"></canvas>
                </div>
                <p id="no-progress-data" class="hidden text-gray-400 text-center py-8">ìš´ë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>
            </div>
        </section>

        <!-- ê¸°ê°„ í•„í„° -->
        <div class="flex gap-2 mb-4">
            <button class="period-btn btn btn-secondary btn-sm" data-period="week">ì´ë²ˆ ì£¼</button>
            <button class="period-btn btn btn-primary btn-sm" data-period="month">ì´ë²ˆ ë‹¬</button>
            <button class="period-btn btn btn-secondary btn-sm" data-period="all">ì „ì²´</button>
        </div>

        <!-- ìš´ë™ ê¸°ë¡ ëª©ë¡ -->
        <section class="bg-white p-6 rounded-lg shadow">
            <h3 class="text-lg font-bold mb-4">ğŸ“ ìš´ë™ ê¸°ë¡</h3>
            <div id="workout-log-list" class="space-y-4">
                <p class="text-gray-400 text-center py-8">ìš´ë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>
            </div>
        </section>
    </main>

    <!-- ê¸°ë¡ ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="add-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 md:p-8 max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4">ğŸ’ª ìš´ë™ ê¸°ë¡ ì¶”ê°€</h3>

            <form id="add-form" class="space-y-4">
                <div>
                    <label for="add-date" class="block text-sm font-medium text-gray-700 mb-2">ë‚ ì§œ</label>
                    <input type="date" id="add-date"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <div>
                    <label for="add-content" class="block text-sm font-medium text-gray-700 mb-2">
                        ìš´ë™ ë‚´ìš© <span class="text-red-500">*</span>
                    </label>
                    <textarea id="add-content" rows="6"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                              placeholder="ì˜ˆì‹œ:
ë ˆê·¸í”„ë ˆìŠ¤ 50kg 10íšŒ 3ì„¸íŠ¸, ì£¼ì˜ì‚¬í•­ - ë¬´ë¦ ì¡°ì‹¬
ë²¤ì¹˜í”„ë ˆìŠ¤ 40kg 8íšŒ 3ì„¸íŠ¸
ëŸ°ë‹ë¨¸ì‹  30ë¶„

ììœ ë¡­ê²Œ ì‘ì„±í•˜ì„¸ìš”!"></textarea>
                </div>

                <!-- AI íŒŒì‹± ë¯¸ë¦¬ë³´ê¸° -->
                <div id="parse-preview" class="hidden">
                    <p class="text-sm font-medium text-gray-700 mb-2">ğŸ¤– AI ë¶„ì„ ê²°ê³¼</p>
                    <div id="parse-preview-content" class="bg-gray-50 p-3 rounded-md text-sm space-y-2">
                    </div>
                </div>

                <div class="flex gap-3">
                    <button type="button" id="preview-btn" class="btn btn-secondary flex-1">
                        AI ë¯¸ë¦¬ë³´ê¸°
                    </button>
                    <button type="submit" class="btn btn-primary flex-1">
                        ì €ì¥í•˜ê¸°
                    </button>
                </div>
                <button type="button" id="close-add-modal" class="btn btn-secondary w-full">
                    ì·¨ì†Œ
                </button>
            </form>
        </div>
    </div>

    <!-- ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 md:p-8 max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4">âœï¸ ìš´ë™ ê¸°ë¡ ìˆ˜ì •</h3>

            <form id="edit-form" class="space-y-4">
                <input type="hidden" id="edit-id">

                <div>
                    <label for="edit-date" class="block text-sm font-medium text-gray-700 mb-2">ë‚ ì§œ</label>
                    <input type="date" id="edit-date"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <div>
                    <label for="edit-content" class="block text-sm font-medium text-gray-700 mb-2">
                        ìš´ë™ ë‚´ìš© <span class="text-red-500">*</span>
                    </label>
                    <textarea id="edit-content" rows="6"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>

                <div class="flex gap-3">
                    <button type="submit" class="btn btn-primary flex-1">ìˆ˜ì •í•˜ê¸°</button>
                    <button type="button" id="close-edit-modal" class="btn btn-secondary flex-1">ì·¨ì†Œ</button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/components.js?v=8"></script>
    <script src="js/auth.js?v=8"></script>
    <script>
        let user = null;
        let currentPeriod = 'month';
        let bodyPartChart = null;
        let progressChart = null;
        let statsData = null;

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async () => {
            user = getUser();
            if (!user || user.role !== 'student') {
                window.location.href = '/';
                return;
            }

            document.getElementById('user-name').textContent = user.name;

            // ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ë³¸ê°’
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('add-date').value = today;

            await loadStats();
            await loadWorkoutLogs();

            setupEventListeners();
        });

        function setupEventListeners() {
            // ê¸°ë¡ ì¶”ê°€ ëª¨ë‹¬
            document.getElementById('open-add-modal').addEventListener('click', () => {
                document.getElementById('add-modal').classList.remove('hidden');
                document.getElementById('add-modal').classList.add('flex');
                document.getElementById('parse-preview').classList.add('hidden');
            });

            document.getElementById('close-add-modal').addEventListener('click', () => {
                document.getElementById('add-modal').classList.add('hidden');
                document.getElementById('add-modal').classList.remove('flex');
            });

            // AI ë¯¸ë¦¬ë³´ê¸°
            document.getElementById('preview-btn').addEventListener('click', previewParsing);

            // ì €ì¥
            document.getElementById('add-form').addEventListener('submit', saveWorkoutLog);

            // ìˆ˜ì • ëª¨ë‹¬
            document.getElementById('close-edit-modal').addEventListener('click', () => {
                document.getElementById('edit-modal').classList.add('hidden');
                document.getElementById('edit-modal').classList.remove('flex');
            });

            document.getElementById('edit-form').addEventListener('submit', updateWorkoutLog);

            // ê¸°ê°„ í•„í„°
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    currentPeriod = e.target.dataset.period;
                    document.querySelectorAll('.period-btn').forEach(b => {
                        b.classList.remove('btn-primary');
                        b.classList.add('btn-secondary');
                    });
                    e.target.classList.remove('btn-secondary');
                    e.target.classList.add('btn-primary');
                    await loadStats();
                    await loadWorkoutLogs();
                });
            });

            // ìš´ë™ ì„ íƒ ë“œë¡­ë‹¤ìš´
            document.getElementById('progress-exercise-select').addEventListener('change', (e) => {
                updateProgressChart(e.target.value);
            });

            // ë¡œê·¸ì•„ì›ƒ
            document.getElementById('logout-btn').addEventListener('click', () => {
                logout();
                window.location.href = '/';
            });
        }

        // í†µê³„ ë¡œë“œ
        async function loadStats() {
            try {
                const response = await fetch(`/api/workout-stats?studentId=${user.id}&period=${currentPeriod}`);
                const data = await response.json();

                if (!response.ok) throw new Error(data.error);

                statsData = data;

                // ìš”ì•½ ì¹´ë“œ ì—…ë°ì´íŠ¸
                document.getElementById('stat-workouts').textContent = `${data.summary.totalWorkouts}íšŒ`;
                document.getElementById('stat-bodypart').textContent = data.summary.mostFrequentBodyPart || '-';
                document.getElementById('stat-streak').textContent = `${data.summary.streak}ì¼`;

                // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
                updateBodyPartChart(data.bodyPartStats);
                populateExerciseSelect(data.progressData);

            } catch (error) {
                console.error('Load stats error:', error);
            }
        }

        // ë¶€ìœ„ë³„ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        function updateBodyPartChart(bodyPartStats) {
            const ctx = document.getElementById('bodyPartChart');
            const noDataMsg = document.getElementById('no-bodypart-data');

            if (!bodyPartStats || bodyPartStats.length === 0) {
                ctx.style.display = 'none';
                noDataMsg.classList.remove('hidden');
                return;
            }

            ctx.style.display = 'block';
            noDataMsg.classList.add('hidden');

            const labels = bodyPartStats.map(s => s.bodyPart);
            const data = bodyPartStats.map(s => s.count);
            const colors = ['#4F46E5', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899'];

            if (bodyPartChart) {
                bodyPartChart.destroy();
            }

            bodyPartChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{
                        data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // ìš´ë™ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
        function populateExerciseSelect(progressData) {
            const select = document.getElementById('progress-exercise-select');
            select.innerHTML = '<option value="">ìš´ë™ ì„ íƒ</option>';

            if (progressData) {
                Object.keys(progressData).forEach(exercise => {
                    const option = document.createElement('option');
                    option.value = exercise;
                    option.textContent = exercise;
                    select.appendChild(option);
                });

                // ì²« ë²ˆì§¸ ìš´ë™ ì„ íƒ
                if (Object.keys(progressData).length > 0) {
                    select.value = Object.keys(progressData)[0];
                    updateProgressChart(Object.keys(progressData)[0]);
                }
            }
        }

        // ì§„í–‰ ì¶”ì´ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        function updateProgressChart(exerciseName) {
            const ctx = document.getElementById('progressChart');
            const noDataMsg = document.getElementById('no-progress-data');

            if (!exerciseName || !statsData?.progressData?.[exerciseName]) {
                ctx.style.display = 'none';
                noDataMsg.classList.remove('hidden');
                return;
            }

            ctx.style.display = 'block';
            noDataMsg.classList.add('hidden');

            const data = statsData.progressData[exerciseName];
            const labels = data.map(d => d.date);
            const weights = data.map(d => d.weight || 0);
            const reps = data.map(d => d.reps || 0);

            if (progressChart) {
                progressChart.destroy();
            }

            progressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'ë¬´ê²Œ (kg)',
                            data: weights,
                            borderColor: '#4F46E5',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            tension: 0.3,
                            yAxisID: 'y'
                        },
                        {
                            label: 'íšŸìˆ˜',
                            data: reps,
                            borderColor: '#10B981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.3,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'ë¬´ê²Œ (kg)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'íšŸìˆ˜' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        // ìš´ë™ ê¸°ë¡ ëª©ë¡ ë¡œë“œ
        async function loadWorkoutLogs() {
            try {
                let url = `/api/workout-logs?studentId=${user.id}`;

                // ê¸°ê°„ í•„í„° ì ìš©
                const now = new Date();
                if (currentPeriod === 'week') {
                    const weekAgo = new Date(now);
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    url += `&startDate=${weekAgo.toISOString().split('T')[0]}`;
                } else if (currentPeriod === 'month') {
                    const monthAgo = new Date(now);
                    monthAgo.setMonth(monthAgo.getMonth() - 1);
                    url += `&startDate=${monthAgo.toISOString().split('T')[0]}`;
                }

                const response = await fetch(url);
                const data = await response.json();

                if (!response.ok) throw new Error(data.error);

                renderWorkoutLogs(data.logs || []);

            } catch (error) {
                console.error('Load workout logs error:', error);
            }
        }

        // ìš´ë™ ê¸°ë¡ ë Œë”ë§
        function renderWorkoutLogs(logs) {
            const container = document.getElementById('workout-log-list');

            if (!logs || logs.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-8">ìš´ë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }

            container.innerHTML = logs.map(log => {
                const logDate = new Date(log.log_date);
                const formattedDate = logDate.toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'short'
                });

                // íŒŒì‹±ëœ ìš´ë™ í‘œì‹œ
                let exercisesHtml = '';
                if (log.exercises && log.exercises.length > 0) {
                    exercisesHtml = log.exercises.map(ex => {
                        let detail = ex.exercise_name;
                        if (ex.weight) detail += ` ${ex.weight}kg`;
                        if (ex.reps) detail += ` Ã— ${ex.reps}íšŒ`;
                        if (ex.sets) detail += ` Ã— ${ex.sets}ì„¸íŠ¸`;
                        if (ex.duration) detail += ` ${ex.duration}ë¶„`;

                        const bodyPartBadge = ex.body_part
                            ? `<span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded">${ex.body_part}</span>`
                            : '';

                        const noteHtml = ex.note
                            ? `<p class="text-xs text-orange-600 mt-1">âš ï¸ ${escapeHtml(ex.note)}</p>`
                            : '';

                        return `
                            <div class="flex items-center gap-2">
                                <span class="text-gray-700">${escapeHtml(detail)}</span>
                                ${bodyPartBadge}
                            </div>
                            ${noteHtml}
                        `;
                    }).join('');
                } else {
                    // íŒŒì‹± ì•ˆ ëœ ê²½ìš° ì›ë³¸ í…ìŠ¤íŠ¸ í‘œì‹œ
                    exercisesHtml = `<p class="text-gray-600 whitespace-pre-line">${escapeHtml(log.content)}</p>`;
                }

                return `
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <div class="flex justify-between items-start mb-3">
                            <span class="text-sm font-medium text-indigo-600">${formattedDate}</span>
                            <div class="flex gap-2">
                                <button onclick="openEditModal(${log.id}, '${log.log_date}', \`${log.content.replace(/`/g, '\\`').replace(/\\/g, '\\\\').replace(/\n/g, '\\n')}\`)"
                                        class="text-xs text-gray-500 hover:text-indigo-600">ìˆ˜ì •</button>
                                <button onclick="deleteWorkoutLog(${log.id})"
                                        class="text-xs text-gray-500 hover:text-red-600">ì‚­ì œ</button>
                            </div>
                        </div>
                        <div class="space-y-1">
                            ${exercisesHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // AI ë¯¸ë¦¬ë³´ê¸°
        async function previewParsing() {
            const content = document.getElementById('add-content').value.trim();
            if (!content) {
                showToast('ìš´ë™ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const previewBtn = document.getElementById('preview-btn');
            previewBtn.disabled = true;
            previewBtn.textContent = 'ë¶„ì„ ì¤‘...';

            try {
                // ì„ì‹œ ì €ì¥ ì—†ì´ íŒŒì‹±ë§Œ ìš”ì²­ (ì‹¤ì œë¡œëŠ” ì„œë²„ì—ì„œ íŒŒì‹± API ë³„ë„ í•„ìš”)
                // ì—¬ê¸°ì„œëŠ” ì €ì¥ í›„ ì‚­ì œí•˜ëŠ” ë°©ì‹ ëŒ€ì‹ , ì €ì¥ ì‹œ ê²°ê³¼ í™•ì¸ìœ¼ë¡œ ëŒ€ì²´
                showToast('ì €ì¥í•˜ê¸°ë¥¼ ëˆ„ë¥´ë©´ AIê°€ ìë™ìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤.', 'info');

                document.getElementById('parse-preview').classList.remove('hidden');
                document.getElementById('parse-preview-content').innerHTML = `
                    <p class="text-gray-500">ì €ì¥ ì‹œ AIê°€ ë‹¤ìŒì„ ë¶„ì„í•©ë‹ˆë‹¤:</p>
                    <ul class="list-disc list-inside text-gray-600">
                        <li>ìš´ë™ëª…, ë¶€ìœ„ ìë™ ë¶„ë¥˜</li>
                        <li>ë¬´ê²Œ, íšŸìˆ˜, ì„¸íŠ¸ ì¶”ì¶œ</li>
                        <li>ì£¼ì˜ì‚¬í•­ ì¸ì‹</li>
                    </ul>
                `;

            } catch (error) {
                console.error('Preview error:', error);
                showToast('ë¯¸ë¦¬ë³´ê¸° ì‹¤íŒ¨', 'error');
            } finally {
                previewBtn.disabled = false;
                previewBtn.textContent = 'AI ë¯¸ë¦¬ë³´ê¸°';
            }
        }

        // ìš´ë™ ê¸°ë¡ ì €ì¥
        async function saveWorkoutLog(e) {
            e.preventDefault();

            const content = document.getElementById('add-content').value.trim();
            const logDate = document.getElementById('add-date').value;

            if (!content) {
                showToast('ìš´ë™ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                showLoading(true);

                const response = await fetch('/api/workout-logs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        studentId: user.id,
                        logDate: logDate || null,
                        content
                    })
                });

                const data = await response.json();
                showLoading(false);

                if (data.ok) {
                    showToast('ìš´ë™ ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');

                    // íŒŒì‹± ê²°ê³¼ í‘œì‹œ
                    if (data.exercises && data.exercises.length > 0) {
                        const exerciseNames = data.exercises.map(e => e.exercise_name).join(', ');
                        showToast(`AI ë¶„ì„: ${exerciseNames}`, 'info');
                    }

                    // ëª¨ë‹¬ ë‹«ê¸° ë° ìƒˆë¡œê³ ì¹¨
                    document.getElementById('add-modal').classList.add('hidden');
                    document.getElementById('add-modal').classList.remove('flex');
                    document.getElementById('add-content').value = '';

                    await loadStats();
                    await loadWorkoutLogs();
                } else {
                    throw new Error(data.error || 'ì €ì¥ ì‹¤íŒ¨');
                }

            } catch (error) {
                console.error('Save error:', error);
                showLoading(false);
                showToast(error.message, 'error');
            }
        }

        // ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
        window.openEditModal = function(logId, logDate, content) {
            document.getElementById('edit-id').value = logId;
            document.getElementById('edit-date').value = logDate;
            document.getElementById('edit-content').value = content.replace(/\\n/g, '\n');

            document.getElementById('edit-modal').classList.remove('hidden');
            document.getElementById('edit-modal').classList.add('flex');
        };

        // ìš´ë™ ê¸°ë¡ ìˆ˜ì •
        async function updateWorkoutLog(e) {
            e.preventDefault();

            const logId = document.getElementById('edit-id').value;
            const content = document.getElementById('edit-content').value.trim();
            const logDate = document.getElementById('edit-date').value;

            if (!content) {
                showToast('ìš´ë™ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                showLoading(true);

                const response = await fetch(`/api/workout-logs?id=${logId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content, logDate })
                });

                const data = await response.json();
                showLoading(false);

                if (data.ok) {
                    showToast('ìš´ë™ ê¸°ë¡ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');

                    document.getElementById('edit-modal').classList.add('hidden');
                    document.getElementById('edit-modal').classList.remove('flex');

                    await loadStats();
                    await loadWorkoutLogs();
                } else {
                    throw new Error(data.error || 'ìˆ˜ì • ì‹¤íŒ¨');
                }

            } catch (error) {
                console.error('Update error:', error);
                showLoading(false);
                showToast(error.message, 'error');
            }
        }

        // ìš´ë™ ê¸°ë¡ ì‚­ì œ
        window.deleteWorkoutLog = async function(logId) {
            if (!confirm('ì´ ìš´ë™ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                showLoading(true);

                const response = await fetch(`/api/workout-logs?id=${logId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                showLoading(false);

                if (data.ok) {
                    showToast('ìš´ë™ ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    await loadStats();
                    await loadWorkoutLogs();
                } else {
                    throw new Error(data.error || 'ì‚­ì œ ì‹¤íŒ¨');
                }

            } catch (error) {
                console.error('Delete error:', error);
                showLoading(false);
                showToast(error.message, 'error');
            }
        };

        // HTML ì´ìŠ¤ì¼€ì´í”„
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
